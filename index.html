<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>wasm-string</title>
        <script>
            const stack = [];
            fetch('main.wasm').then(response =>
                response.arrayBuffer()
            ).then(bytes =>
                WebAssembly.instantiate(bytes, { env: {
                    stack_push: (thing) => {stack.push(thing);},
                    console_log_stack: () => {
                        console.log(
                            String.fromCharCode(...stack.splice(0, stack.length))
                        );
                    }
                }})
            ).then(results => {
                const { instance } = results;
                function getString(str) {
                    instance.exports[str]();
                    const [pointer, length] = [stack.pop(), stack.pop()];
                    const buffer = new Uint8Array(
                        instance.exports.memory.buffer,
                        pointer,
                        length,
                    );
                    const string = String.fromCharCode(...buffer);
                    instance.exports.deallocate_string(pointer);
                    return string;
                }

                alert(getString('string_export'));
            });
        </script>
    </head>
</html>
